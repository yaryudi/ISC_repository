<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Chat Room</h1>
    
    <!-- 고객 1번, 2번이 참여할 채팅방 -->
    <div>
        <h2>Customer 1 and Customer 2</h2>
        <button onclick="joinChat(1, 2)">Join Room 1 & 2</button>
        <div id="chatRoom_1_2" style="display:none;">
            <textarea id="messageBox_1_2" placeholder="Type a message..."></textarea>
            <button onclick="sendMessage(1, 2)">Send Message</button>
            <div id="messages_1_2"></div>
        </div>
    </div>
    

    
    <script>
        // 소켓 서버에 연결
const socket = io.connect('http://127.0.0.1:5000');

// 특정 채팅방에 참여하는 함수
function joinChat(customerId1, customerId2) {
    const roomId = `room_${customerId1}_${customerId2}`;  // 방 ID 생성 (고객 ID에 따라) - 캐시의 _ID에서 추출
    socket.emit('join_chat', { room_id: roomId, customer_id: customerId1 });// 방_ID의 정보에서 추출
    
    // 해당 방에 참여한 고객에 맞게 UI를 변경
    document.getElementById(`chatRoom_${customerId1}_${customerId2}`).style.display = 'block';
    console.log(`Customer ${customerId1} has joined room ${roomId}`);

    //DB의 대화기록을 출력한다.
}

// 메시지를 보내는 함수
function sendMessage(customerId1, customerId2) {
    const roomId = `room_${customerId1}_${customerId2}`;
    const message = document.getElementById(`messageBox_${customerId1}_${customerId2}`).value;

    if (message.trim() !== "") {
        // 메시지를 서버로 전송
        socket.emit('send_message', {
            room_id: roomId,
            message: message
        });

        // 전송한 메시지를 UI에 추가
        const messagesDiv = document.getElementById(`messages_${customerId1}_${customerId2}`);
        const newMessage = document.createElement('div');
        newMessage.textContent = `You: ${message}`;
        messagesDiv.appendChild(newMessage);

        // 전송한 메시지를 DB에 추가
        
        // 메시지 전송 후 입력 박스를 비움
        document.getElementById(`messageBox_${customerId1}_${customerId2}`).value = '';
    }
}

// 서버로부터 받은 메시지를 UI에 추가하는 함수
socket.on('receive_message', (data) => {
    const roomId = data.room_id;
    const message = data.message;
    
    // 메시지가 어떤 채팅방에 속하는지 구분해서 메시지 표시
    const customerId1 = roomId.split('_')[1];
    const customerId2 = roomId.split('_')[2];
    
    const messagesDiv = document.getElementById(`messages_${customerId1}_${customerId2}`);
    const newMessage = document.createElement('div');
    newMessage.textContent = `Other: ${message}`;
    messagesDiv.appendChild(newMessage);
});
    </script>
</body>
</html>

